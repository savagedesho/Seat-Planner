from collections import defaultdict
from typing import List, Dict, Any, Optional

Student = Dict[str, Any]

def make_seating_plan(
    students: List[Student],
    absences: Optional[List[str]] = None,
    rows: int = 4,
    cols: int = 5,
) -> List[List[Optional[str]]]:
    """
    Create a seating plan.

    students: list of dicts like:
      {
        "name": "Aiko",
        "level": "low" / "mid" / "high",
        "needs_front": True / False
      }

    absences: list of names who are absent today
    rows, cols: classroom layout
    """

    if absences is None:
        absences = []

    # 1. Filter out absent students
    present_students = [s for s in students if s["name"] not in absences]

    # 2. Group students by level so we can mix them
    level_groups: Dict[str, List[Student]] = defaultdict(list)
    for s in present_students:
        level_groups[s.get("level", "unknown")].append(s)

    # Sort inside each level for stable, predictable results
    for lvl in level_groups:
        level_groups[lvl].sort(key=lambda x: x["name"])

    # 3. Round-robin pick from each level to spread them out
    levels = list(level_groups.keys())
    ordered: List[Student] = []
    idx = 0

    while any(level_groups.values()):
        lvl = levels[idx % len(levels)]
        if level_groups[lvl]:
            ordered.append(level_groups[lvl].pop(0))
        idx += 1
        if idx > 10_000:  # safety break
            break

    # 4. Move "needs_front" students to the beginning
    front_students = [s for s in ordered if s.get("needs_front")]
    other_students = [s for s in ordered if not s.get("needs_front")]
    final_order = front_students + other_students

    # 5. Fill the seating grid row by row (front is row 0)
    grid: List[List[Optional[str]]] = [
        [None for _ in range(cols)] for _ in range(rows)
    ]

    pos = 0
    for r in range(rows):
        for c in range(cols):
            if pos < len(final_order):
                grid[r][c] = final_order[pos]["name"]
                pos += 1

    return grid


# Example usage
if __name__ == "__main__":
    students = [
        {"name": "Aiko", "level": "low", "needs_front": True},
        {"name": "Ben", "level": "high", "needs_front": False},
        {"name": "Chika", "level": "mid", "needs_front": True},
        {"name": "Diego", "level": "low", "needs_front": False},
        {"name": "Emi", "level": "high", "needs_front": False},
        {"name": "Farid", "level": "mid", "needs_front": False},
        {"name": "Hana", "level": "low", "needs_front": False},
    ]

    absences_today = ["Chika"]
    rows = 3
    cols = 3

    plan = make_seating_plan(students, absences_today, rows, cols)

    print("Seating plan:")
    for r in range(rows):
        row_display = []
        for c in range(cols):
            name = plan[r][c] or "EMPTY"
            row_display.append(f"{name:10}")
        print(" | ".join(row_display))
